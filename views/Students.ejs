<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/public/css/all.min.css">
    <link rel="stylesheet" href="/public/css/chatui.css">
    <link rel="stylesheet" href="/public/css/students.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/vendor/jquery/jquery.min.js"></script>
    <title>Students</title>
</head>
<body>
    <%   
    var value_img="";
        if(profile.image){
            value_img = profile.image;
        }else{
            value_img = profile;
        }  
    %>

    <div class="body-container" style="display: block;">
        <nav>
            <div class="nav-left">
               <img src="/public/images/round_dehaze_white_24dp.png" class="menu-nav">
                <h4 style="color: aliceblue; margin-left: 20px; margin-top: 10px;"><b>Easy <span style="color: dodgerblue;">School</span></b></h4>
              <!--   <img src="share_1.png" class="logo">
               <ul>
                    <li><img src="images/notification.png"></li>
                    <li><img src="images/video.png" ></li>
                    <li><img src="images/inbox.png" ></li>
                </ul>
                -->
            </div>
    
            <div class="nav-right">

                <script>
                    function readNotification(self){
                        var _id = self.getAttribute("data-id");
                        var ajax = new XMLHttpRequest();
                        ajax.open("POST","/read-notifictaion",true);
                        ajax.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                        ajax.onreadystatechange = function(){
                            if(this.readyState==4 && this.status==200){
                                var response = JSON.parse(this.responseText);
                                if(response.status=="error"){
                                    alert(response.message);
                                }
                            }
                        }
                        ajax.send("notificationId="+_id);
                        return true;
                    }

                    
                    var ajax = new XMLHttpRequest();
                    ajax.open("GET","/get_user",true);

                    ajax.onreadystatechange = function(){
                        if(this.readyState==4 && this.status==200){
                            var response = JSON.parse(this.responseText);
                            if(response.status=="success"){
                                window.user = response.user;
                                var html = "";
                                window.user.notifications = window.user.notifications.reverse();
                                for(var a=0;a<window.user.notifications.length;a++){
                                    var notification = window.user.notifications[a];
                                    if(!notification.is_read){
                                        if(notification.type=="new_comment"){
                                            html += '<a class="dropdown-item" onclick="return readNotification(this);" data-id="'+notification._id+'" href="#">New comment</a>';
                                        }
                                    }
                                }
                                document.getElementById("unread-notifications").innerHTML = html;
                            }else{
                            alert(response.message)
                            }  
                        }
                    };

                    ajax.send()
                </script>

                <div class="nav-user-icon online" onclick="settingsMenuToggle()">
                    <img src="<%=value_img%>">
                </div>
            </div>
    
            <!-------- Settings Menu -------->
            <div class="settings-menu">
                <div id="dark-btn">
                    <span></span>
                </div>
                <div class="settings-menu-inner">
                    <div class="user-profile">
                        <img src="<%=value_img%>">
                        <div>
                            <p><%=users.name%></p>
                           <a href="/profile">Your Profile</a>
                        </div>
                    </div>
                    <hr>
                    <div class="settings-links">
                        <img src="/public/images/setting.png" class="settings-icon">
                        <a href="#">Settings </a>
                    </div>
                    <hr>
                    <div class="settings-links">
                        <img src="/public/images/help.png" class="settings-icon">
                        <a href="#">Help</a>
                    </div>
                    <hr>
                    <div class="settings-links">
                        <img src="/public/images/logout.png" class="settings-icon">
                        <a href="#">Logout</a>
                    </div>
                </div>
            </div>
        </nav>
        <div class="students-header">
            <div class="header-st">
                <button>All</button>
                <button>Classmates</button>
            </div>
           
        </div>

        <div class="students-list" >
            
            <div class="list"> 
                <%all.forEach((student)=>{%>
                    <div class="indiv-list">

                        <div class="img-user">

                            <div class="img-1">
                                <%if(student.profile){%>
                                    <%var img_value={};
                                    var last_pick="";%>
                                    <%student.profile.forEach((last)=>{
                                        if(last.image){
                                            
                                            img_value = last.image

                                            }
                                    })%>
                                    <%if(img_value){%>
                                        <img src="<%=img_value%>">
                                    <%}else{%>
                                        <img src="/public/images/avatar.png">
                                        <%}%>

                                    <%}else{%>
                                    <img src="/public/images/avatar.png">
                                <%}%>
                            </div>

                        </div>

                        <div class="bottom-name">

                            <div class="pro-name-1">
                                <p><b><%=student.name%></b></p>
                                <p><b><%=student.email%></b></p>
                            </div>

                            <div class="bottom-school">
                                <p>Chilumba Secondary School</p>
                            </div>
                           
                            <div class="left-action-student-btn">
                                <form onsubmit="return doPost(this);">
                                    <input type="hidden" name="userId" value="<%=student._id%>">
                                    <input type="hidden" name="user" value="<%=student.name%>">
                                    <div class="submit-btns">
                                        <button type="submit" name="submit">
                                            <i class="fa fa-user-plus"></i>
                                            <span>Connect</span>
                                        </button>
                                        <button >
                                            <i class="fa fa-user-minus"></i>
                                            <span>Ignore</span>
                                        </button>
                                    </div>
                                </form>
                            </div>

                        </div>                 

                    </div>
                <%})%>
            </div>

        </div>
    </div>

    
    <script>
        function doPost(form){
            var formData={
                name:form.user.value,
                id:form.userId.value
            };
            $.ajax({
                url:"/add-friend",
                method:"POST",
                data:formData,
                success:function(response){
                     formData._id = response._id; 
                     var socket = io();
                     socket.emit("new_friend_chat",formData);
                }
            });
            return false;
        }
</script>
</body>
</html>